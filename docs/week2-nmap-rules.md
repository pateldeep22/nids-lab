NIDS Project - Week 2 Report: Detecting Network Reconnaissance
Author: [Deep Patel]

1.0 Introduction
1.1 Objective
The primary objective for Week 2 was to advance from baseline testing to active threat detection. This involved researching, writing, and verifying custom NIDS rules designed to detect common network reconnaissance techniques. The focus was on identifying various stealthy scans generated by the Nmap (Network Mapper) tool.

1.2 Methodology
For each scan type, a three-phase process was followed:

Rule Development: A specific Suricata rule was crafted to identify the unique signature of the scan.

Attack Simulation: The Nmap tool was used from the Kali Linux machine to launch the corresponding scan against the Windows 10 victim.

Verification: The Suricata log files were analyzed to confirm that the correct alert was generated.

2.0 Conceptual Overview: TCP Scans & Flags
Before developing rules, it is crucial to understand how TCP scans work. Most advanced scans operate by manipulating TCP flags, which are special bits in a packet's header that control the state of a connection. Think of them as non-verbal cues in a conversation.

SYN (Synchronize): The "Hello, I'd like to start a conversation" flag.

ACK (Acknowledge): The "I heard you" flag.

FIN (Finish): The "Goodbye, I'm done talking" flag.

RST (Reset): The "Stop/Something is wrong" flag.

PSH (Push): The "Send the data I have immediately" flag.

URG (Urgent): The "This data is important" flag.

By sending packets with unusual combinations of these flags, attackers can learn about a target system without establishing a full, normal connection. Our goal is to detect these unusual combinations.

3.0 Test 1: TCP SYN Scan (Stealth Scan)
3.1 Concept
A SYN scan is known as a "stealth scan" or "half-open scan." The attacker sends a SYN packet as if to start a connection but immediately sends an RST packet to tear it down as soon as the target replies with a SYN/ACK. This allows the attacker to see if a port is open without completing the three-way handshake, making the scan harder to log for simple systems.

3.2 Rule Development
A rule was written to detect a TCP packet that contains only a SYN flag, which is the unique first step of this scan.

File: /etc/suricata/rules/week2.rules

Rule:

alert tcp any any -> $HOME_NET any (msg:"NMAP TCP SYN Scan Detected"; flags:S,12; sid:1000002; rev:1;)

Rule Explanation:

alert tcp: Look at TCP traffic and create an alert.

$HOME_NET any: The destination must be our protected network on any port.

msg:"...": The custom alert message.

flags:S,12;: The core logic. This checks for a packet where the SYN flag is set, but the ACK and FIN flags are not set. This is the specific signature of the initial scan packet.

sid:1000002;: A new, unique ID for this rule.

3.3 Testing & Verification
The following commands were executed sequentially on the Kali Linux VM.

Start the NIDS:

# Clear any previous logs for a clean test.
sudo rm /var/log/suricata/eve.json

# Start Suricata in the background as a daemon (-D).
sudo suricata -c /etc/suricata/suricata.yaml -i eth0 -D

Launch the Attack:

# -sS: Specifies a TCP SYN scan.
# -Pn: Tells Nmap not to send an initial ping, bypassing the victim's firewall block.
# 192.168.70.20: The IP address of our Windows 10 victim.
sudo nmap -sS -Pn 192.168.70.20

Verify the Alert:

# Stop the Suricata service to ensure all logs are written.
sudo killall suricata

# Search the log file for our custom alert message.
grep "NMAP TCP SYN Scan" /var/log/suricata/eve.json

Result: The grep command successfully found and displayed the alert, confirming the detection.

4.0 Test 2: TCP FIN Scan
4.1 Concept
A FIN scan sends a TCP packet with only the FIN flag set. A closed port will ignore this packet, while an open port will respond with an RST packet. Attackers use the response (or lack thereof) to determine the port's state.

4.2 Rule Development
File: /etc/suricata/rules/week2.rules

Rule:

alert tcp any any -> $HOME_NET any (msg:"NMAP FIN Scan Detected"; flags:F,12; sid:1000003; rev:1;)

Rule Explanation: The logic is identical to the SYN scan rule, but the flag check is different. flags:F,12; looks for a packet with only the FIN flag set.

4.3 Testing & Verification
Start the NIDS: (Same as above: rm, suricata -D)

Launch the Attack:

# -sF: Specifies a TCP FIN scan.
sudo nmap -sF -Pn 192.168.70.20

Verify the Alert:

sudo killall suricata
grep "NMAP FIN Scan" /var/log/suricata/eve.json

Result: The alert was successfully found in the log file.

5.0 Test 3: TCP Xmas Scan
5.1 Concept
An Xmas scan sends a malformed packet that is "lit up" with three flags at once: FIN, PSH, and URG. This combination is invalid in normal communication. Open ports respond with an RST packet.

5.2 Rule Development
File: /etc/suricata/rules/week2.rules

Rule:

alert tcp any any -> $HOME_NET any (msg:"NMAP Xmas Scan Detected"; flags:FPU,12; sid:1000004; rev:1;)

Rule Explanation: flags:FPU,12; looks for a packet where the FIN, PSH, and URG flags are all set simultaneously.

4.3 Testing & Verification
Start the NIDS: (Same as above)

Launch the Attack:

# -sX: Specifies a TCP Xmas scan.
sudo nmap -sX -Pn 192.168.70.20

Verify the Alert:

sudo killall suricata
grep "NMAP Xmas Scan" /var/log/suricata/eve.json

Result: The alert was successfully found in the log file.

6.0 Test 4: TCP Null Scan
6.1 Concept
A Null scan is the opposite of an Xmas scan. It sends a packet with no flags set at all. This is also an invalid packet that will elicit an RST response from an open port.

6.2 Rule Development
File: /etc/suricata/rules/week2.rules

Rule:

alert tcp any any -> $HOME_NET any (msg:"NMAP Null Scan Detected"; flags:0; sid:1000005; rev:1;)

Rule Explanation: flags:0; looks for a packet where the value of the flags field is exactly zero, meaning no flags are set.

4.3 Testing & Verification
Start the NIDS: (Same as above)

Launch the Attack:

# -sN: Specifies a TCP Null scan.
sudo nmap -sN -Pn 192.168.70.20

Verify the Alert:

sudo killall suricata
grep "NMAP Null Scan" /var/log/suricata/eve.json

Result: The alert was successfully found in the log file.

7.0 Week 2 Conclusion
The objectives for Week 2 were successfully met. Four distinct and effective custom rules were developed to detect common Nmap stealth scanning techniques. Each rule was systematically tested and verified, proving the NIDS is capable of identifying network reconnaissance activities. This foundational ruleset is now ready to be expanded upon in the subsequent phases of the project.
